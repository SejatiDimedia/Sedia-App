---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { db, schema, eq, desc } from "../../lib/db";

// Fetch all published articles with their topic info
const allArticles = await db.query.articles.findMany({
    where: (articles, { eq }) => eq(articles.isPublished, true),
    with: {
        topic: true,
    },
    orderBy: (articles, { desc }) => [desc(articles.createdAt)],
});
---

<BaseLayout title="Perpustakaan | NoltPedia">
    <div class="mb-16">
        <h1
            class="text-5xl md:text-7xl font-black uppercase mb-4 leading-tight"
        >
            Perpustakaan
        </h1>
        <p class="text-xl opacity-70 max-w-2xl font-medium">
            Arsip digital untuk segala jenis dokumentasi teknis. Dari
            fundamental hingga implementasi high-level.
        </p>
    </div>

    <div class="space-y-12">
        {
            allArticles.map((article) => (
                <article class="neo-card p-0 bg-white overflow-hidden flex flex-col md:flex-row hover:neo-shadow-lg transition-all border-4 border-black group">
                    {/* Topic Indicator */}
                    <div class="w-full md:w-48 bg-black text-white p-6 flex flex-col justify-center items-center text-center">
                        <span class="text-[10px] font-black uppercase tracking-widest opacity-50 mb-2">
                            Topik
                        </span>
                        <span class="text-lg font-black uppercase leading-tight">
                            {article.topic?.name || "General"}
                        </span>
                        <a
                            href={`/topics/${article.topic?.id}`}
                            class="mt-4 text-[10px] font-bold border border-white/30 px-2 py-1 hover:bg-white hover:text-black transition-colors"
                        >
                            Lihat Topik
                        </a>
                    </div>

                    {/* Content */}
                    <div class="flex-1 p-8 flex flex-col">
                        <div class="flex items-center gap-4 mb-3">
                            <span class="text-[10px] font-bold uppercase py-1 px-2 border-2 border-black">
                                {article.difficulty}
                            </span>
                            <span class="text-xs font-mono opacity-40">
                                {new Date(
                                    article.createdAt || new Date(),
                                ).toLocaleDateString("id-ID", {
                                    year: "numeric",
                                    month: "long",
                                    day: "numeric",
                                })}
                            </span>
                        </div>

                        <h2 class="text-3xl font-black uppercase mb-4 group-hover:text-blue-600 transition-colors">
                            <a href={`/articles/${article.slug}`}>
                                {article.title}
                            </a>
                        </h2>

                        <p class="text-zinc-600 leading-relaxed mb-8 max-w-3xl">
                            {article.excerpt}
                        </p>

                        <div class="mt-auto flex items-center justify-between">
                            <a
                                href={`/articles/${article.slug}`}
                                class="neo-btn bg-yellow-400 text-sm font-black uppercase px-6 py-2"
                            >
                                Mulai Baca â†’
                            </a>
                            <div class="hidden sm:flex items-center gap-2 opacity-30 text-[10px] font-black">
                                <span>{article.viewCount || 0} DILIHAT</span>
                                <span class="w-1 h-1 bg-black rounded-full" />
                                <span>MDX V1.0</span>
                            </div>
                        </div>
                    </div>
                </article>
            ))
        }
    </div>

    {
        allArticles.length === 0 && (
            <div class="neo-card p-20 text-center bg-zinc-50 border-dashed border-4 border-black/10">
                <h3 class="text-2xl font-black uppercase opacity-30">
                    Perpustakaan sedang kosong.
                </h3>
                <p class="mt-2 opacity-40">
                    Kurator kami sedang menyiapkan naskah logika baru.
                </p>
            </div>
        )
    }
</BaseLayout>
