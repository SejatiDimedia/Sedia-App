---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { db, schema, asc } from "../../lib/db";

// Fetch all terms
const terms = await db.query.glossary.findMany({
    orderBy: [asc(schema.glossary.term)],
});

// Group terms by their first letter
const groupedTerms = terms.reduce(
    (acc, term) => {
        const firstLetter = term.term.charAt(0).toUpperCase();
        if (!acc[firstLetter]) {
            acc[firstLetter] = [];
        }
        acc[firstLetter].push(term);
        return acc;
    },
    {} as Record<string, typeof terms>,
);

const alphabet = Object.keys(groupedTerms).sort();
---

<BaseLayout title="Glossary | NoltPedia">
    <div class="mb-16">
        <h1 class="text-6xl font-black uppercase mb-4 leading-none">
            The Glossary
        </h1>
        <p class="text-xl opacity-70 max-w-2xl font-medium">
            Kumpulan terminologi teknis yang dibedah hingga ke akar logikanya.
            No buzzwords, just clear definitions.
        </p>
    </div>

    {/* Alphabet Nav */}
    <div class="flex flex-wrap gap-2 mb-12">
        {
            alphabet.map((letter) => (
                <a
                    href={`#letter-${letter}`}
                    class="neo-btn text-xs px-3 py-1 bg-zinc-200 hover:bg-yellow-400 font-black"
                >
                    {letter}
                </a>
            ))
        }
    </div>

    <div class="space-y-16">
        {
            alphabet.map((letter) => (
                <section id={`letter-${letter}`} class="scroll-mt-24">
                    <div class="border-b-4 border-black mb-8 pb-2 flex items-end justify-between">
                        <h2 class="text-6xl font-black text-blue-600 leading-none">
                            {letter}
                        </h2>
                        <span class="text-xs font-black opacity-30 uppercase">
                            {groupedTerms[letter].length} Terms
                        </span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-10">
                        {groupedTerms[letter].map((term) => (
                            <div class="group">
                                <h3 class="text-2xl font-black uppercase mb-3 flex items-center gap-3">
                                    <span class="w-2 h-2 bg-yellow-400 border border-black transform rotate-45" />
                                    {term.term}
                                </h3>
                                <p class="text-zinc-600 leading-relaxed text-sm">
                                    {term.definition}
                                </p>
                                {term.relatedArticleId && (
                                    <a
                                        href={`/articles/${term.relatedArticleId}`}
                                        class="inline-flex items-center gap-2 mt-4 text-[10px] font-black uppercase text-blue-600 hover:underline"
                                    >
                                        Read Deep Dive <span>â†’</span>
                                    </a>
                                )}
                            </div>
                        ))}
                    </div>
                </section>
            ))
        }
    </div>

    {
        terms.length === 0 && (
            <div class="neo-card p-20 text-center bg-zinc-50 border-dashed border-4 border-black/10">
                <h3 class="text-2xl font-black uppercase opacity-30">
                    Glosarium masih dalam proses kurasi.
                </h3>
                <p class="mt-2 opacity-40">
                    Kami sedang mendefinisikan fundamental satu per satu.
                </p>
            </div>
        )
    }
</BaseLayout>
