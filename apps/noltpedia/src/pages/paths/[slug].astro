---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { db, paths, pathSteps, eq, asc } from "../../lib/db";

const { slug } = Astro.params;
if (!slug) return Astro.redirect("/paths");

const path = await db.query.paths.findFirst({
    where: eq(paths.slug, slug),
});

if (!path) return Astro.redirect("/404");

const steps = await db.query.pathSteps.findMany({
    where: eq(pathSteps.pathId, path.id),
    orderBy: [asc(pathSteps.stepOrder)],
    with: {
        article: true,
    },
});
---

<BaseLayout title={path.title}>
    <div class="max-w-4xl mx-auto px-4 py-12">
        <!-- Header -->
        <div class="mb-12">
            <div
                class="inline-block bg-yellow-400 border-2 border-black px-3 py-1 font-mono text-xs uppercase font-bold mb-4 shadow-[2px_2px_0px_0px_#000]"
            >
                Learning Roadmap
            </div>
            <h1
                class="text-5xl font-black uppercase tracking-tighter mb-4 leading-tight"
            >
                {path.title}
            </h1>
            <p class="text-xl font-mono text-zinc-600">
                {path.description}
            </p>
        </div>

        <!-- Curriculum List -->
        <div class="space-y-6">
            <h2
                class="text-2xl font-black uppercase border-b-8 border-black pb-2 mb-8"
            >
                The Syllabus
            </h2>

            {
                steps.map((step, index) => (
                    <a
                        href={`/articles/${step.article.slug}?path=${path.slug}`}
                        class="block group"
                    >
                        <div class="neo-card p-6 bg-white flex items-center gap-6 transition-transform group-hover:-translate-y-1">
                            <div class="bg-black text-white w-12 h-12 flex items-center justify-center font-black text-xl shrink-0 shadow-[4px_4px_0px_0px_#FACC15]">
                                {index + 1}
                            </div>
                            <div class="flex-grow">
                                <h3 class="text-xl font-black uppercase group-hover:underline">
                                    {step.article.title}
                                </h3>
                                <p class="text-sm font-mono text-zinc-500 line-clamp-1">
                                    {step.article.excerpt}
                                </p>
                            </div>
                            <div class="font-mono text-xs uppercase font-bold opacity-30 group-hover:opacity-100 transition-opacity">
                                Read Step â†’
                            </div>
                        </div>
                    </a>
                ))
            }

            {
                steps.length === 0 && (
                    <div class="p-12 text-center neo-card bg-zinc-50 border-4 border-dashed border-black opacity-50">
                        <p class="font-bold uppercase">
                            Syllabus is being populated...
                        </p>
                    </div>
                )
            }
        </div>

        {
            steps.length > 0 && (
                <div class="mt-16 text-center">
                    <a
                        href={`/articles/${steps[0].article.slug}?path=${path.slug}`}
                        class="neo-btn bg-black text-white text-xl px-12 py-4 inline-block font-black uppercase hover:bg-zinc-800"
                    >
                        Start Learning Now
                    </a>
                </div>
            )
        }
    </div>
</BaseLayout>
